From 3d01b2676a7ca0d9d615b4daca046b2dc719b3d2 Mon Sep 17 00:00:00 2001
From: Carsten Hansen <Carsten.Hansen@bksv.com>
Date: Mon, 4 May 2020 12:46:26 +0800
Subject: [PATCH] SLX-417-Fix-race-with-bluetooth-driver

---
 drivers/net/wireless/laird/lrdmwl/sdio.c | 21 ++++++++++-----------
 1 file changed, 10 insertions(+), 11 deletions(-)

diff --git a/drivers/net/wireless/laird/lrdmwl/sdio.c b/drivers/net/wireless/laird/lrdmwl/sdio.c
index 9454551..c6415e8 100644
--- a/drivers/net/wireless/laird/lrdmwl/sdio.c
+++ b/drivers/net/wireless/laird/lrdmwl/sdio.c
@@ -917,20 +917,19 @@ static int mwl_sdio_program_firmware(struct mwl_priv *priv)
 
 		if (ret  == 0 && firmware_status == FIRMWARE_READY_SDIO) {
 			wiphy_err(priv->hw->wiphy,
-				"Firmware already initialized! Resetting radio...\n");
-
-			if (priv->if_ops.down_dev)
-				priv->if_ops.down_dev(priv);
-
-			ret = mwl_sdio_reset(priv);
-
-			if (priv->if_ops.up_dev)
-				priv->if_ops.up_dev(priv);
+				"Firmware already initialized!\n");
 
+			ret = mwl_check_fw_status(priv, MAX_FIRMWARE_POLL_TRIES);
 			if (ret) {
-				kfree(fwbuf);
-				return ret;
+				wiphy_err(priv->hw->wiphy, "FW status is not ready\n");
 			}
+
+			/* Enabling interrupt after firmware is ready.
+			* Otherwise there may be abnormal interrupt DN_LD_HOST_INT_MASK
+			*/
+			mwl_sdio_enable_int(priv, true);
+			kfree(fwbuf);
+			return 0;
 		}
 		else
 			break;
